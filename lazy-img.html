<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="poly-poly.html">

<!--
`lazy-img`
Lazy loading img element, delays loading images until they come into the viewport

@demo demo/index.html
-->

<dom-module id="lazy-img">
  <template>
    <style>
      :host {
        display: inline-block;
        overflow: hidden;
        position: relative;
      }

      img {
        display: block;
        width: var(--lazy-img-width, auto);
        height: var(--lazy-img-height, auto);
        @apply(--lazy-img);
      }

      img.loaded {
        @apply(--lazy-img-loaded);
      }
    </style>
    <img id="img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="[[alt]]">
  </template>

  <script>
    (function() {
      'use strict';

      var observerPromise = window.PolyPoly.ready.then(function() {
        return new IntersectionObserver(function(entries){
          for(var i = 0; i < entries.length; i++) {
            entries[i].target._load();
          }
        });
      });

      Polymer({
        is: 'lazy-img',

        properties: {
          /** The source URL for the image */
          src: {
            type: String
          },

          /** The alt attribute for the image */
          alt: {
            type: String
          }
        },

        _load: function() {
          var img = this.$.img;
          img.onload = function() {
            img.classList.add('loaded');
          };
          img.src = this._resolveSrc(this.src);

          // stop observing
          this.detached();
        },

        _resolveSrc: function(testSrc) {
          var baseURI = /** @type {string} */(this.ownerDocument.baseURI);
          return (new URL(Polymer.ResolveUrl.resolveUrl(testSrc, baseURI), baseURI)).href;
        },

        attached: function() {
          observerPromise.then(function(observer) {
            observer.observe(this);
          }.bind(this));
        },

        detached: function() {
          observerPromise.then(function(observer) {
            observer.unobserve(this);
          }.bind(this));
        }
      });
    })();
  </script>
</dom-module>
