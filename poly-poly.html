<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">

<script>
  (function() {
    'use strict';

    window.PolyPoly = window.PolyPoly || {};

    var resolveFn, rejectFn;
    var loadedPromise = new Promise(function(resolve, reject) {
      resolveFn = resolve;
      rejectFn = reject;
    });

    /**
     * Polymer behavior to provide a promise that resolves when polyfilling is complete
     *
     * @polymerBehavior PolyPoly.Behavior
     */
    window.PolyPoly.Behavior = {
      properties: {
        completes: {
          type: Object,
          readOnly: true,
          value: loadedPromise
        }
      },

      registered: function() {
        if (window.PolyPoly.features) {
          if (window.PolyPoly.features.length) {
            // Include a `ua` argument set to a supported browser to skip UA identification
            // (improves response time) and avoid being treated as unknown UA (which would
            // otherwise result in no polyfills, even with `always`, if UA is unknown)
            var url = 'https://polyfill.io/v2/polyfill.min.js?features=' + window.PolyPoly.features.join(',') + '&flags=gated,always&ua=chrome/50';
            var script = document.createElement('script');
            script.async = true;
            script.src = url;
            script.onload = resolveFn;
            script.onerror = rejectFn;
            document.head.appendChild(script);
          } else {
            resolveFn();
          }
        } else {
          console.log("window.PolyPoly.features not defined - you may be using an element that requires polyfills");
          rejectFn();
        }
      }
    }

    /**
     * poly-poly is an element that can be used to check the state of polyfill loading
     */
    Polymer({
      is: 'poly-poly',
      behaviors: [ window.PolyPoly.Behavior ]
    });

  })();
</script>
